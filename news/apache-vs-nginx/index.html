<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <title>Apache vs. NGINX: Match of the Millennium</title>
    <link href="/style.css?1671124519" rel="stylesheet">

    <link rel="shortcut icon" type="image/png" href="/favicon.png" />

    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    
<meta property="og:title" content="Apache vs. NGINX: Match of the Millennium" />
<meta property="og:description" content="Here is the second article in the performance series we started last year, dealing with the old feud between Apache and NGINX." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://build.prestashop-project.org/news/apache-vs-nginx/" />
    <meta property="article:section" content="news" />
    <meta property="article:published_time" content="2021-01-20T16:30:00+01:00" />
    <meta property="article:modified_time" content="2021-01-20T16:30:00+01:00" />

  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:image" content="https://build.prestashop-project.org/assets/images/theme/meta-logo-build.png">
<meta name="twitter:title" content="Apache vs. NGINX: Match of the Millennium"/>
<meta name="twitter:description" content="Dream match never ends"/>
<meta name="twitter:site" content="@PrestaShopOrg"/>

		<script type="application/javascript">
			var doNotTrack = false;
			if (!doNotTrack) {
				(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
					(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
								m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
				})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
				ga('create', 'UA-2753771-31', 'auto');
				
				ga('send', 'pageview');
			}
		</script>
</head>


  <body>

  <header class="site-header">

  <div class="container">
    <div class="row clearfix">

      <div class="menu-button"><i class="icon icon-store"></i></div>
      <div class="search-button"><i class="icon icon-magnifying-glass"></i></div>

      <div id="logo" class="">
        
        <a href="https://build.prestashop-project.org">
          <img src="/assets/images/theme/new-logo.png" alt="PrestaShop Developers&#39; blog Logo">
        </a>
      </div>

      <div id="navigation" class="">
        <nav>
  <ul id="main-navigation" class="nav navbar-nav navbar-collapse">
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
        News <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
        <li><a href="/tag/releases/">Latest releases</a></li>
        <li><a href="/tag/core-weekly/">Core Weekly</a></li>
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
        Project <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
        <li><a href="/tag/8.0/">Articles on 8.0</a></li>
        <li><a href="/tag/1.7/">Articles on 1.7</a></li>
        <li><a href="/tag/1.6/">Articles on 1.6</a></li>
        <li><a href="https://nightly.prestashop.com">Nightly Builds</a></li>
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
        Contribute <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
        <li><a href="/howtos/misc/contribute-to-prestashop/">Contributor's guide</a></li>
        <li><a href="http://contributors.prestashop.com/">Contributor's page</a></li>
        <li><a href="http://translators.prestashop.com/">Translators' page</a></li>
      </ul>
    </li>
    <li class="dropdown">
      <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">
        Learn <span class="caret"></span>
      </a>
      <ul class="dropdown-menu">
        <li><a href="/howtos/">How-tos</a></li>
        <li><a href="/tools/">Tools</a></li>
        <li><a href="https://devdocs.prestashop-project.org/1.7/contribute/">Devdocs</a></li>
        <li><a href="/news/how-to-best-contact-us/">How to best contact us</a></li>
      </ul>
    </li>
    <li class="">
      <a href="/about/">About</a>
    </li>
  </ul>
</nav>

      </div>

      <div id="algolia-container">
        <div class="aa-input-container" id="aa-input-container">
          <input type="search" id="aa-search-input" class="aa-input-search form-control" placeholder="Search..." name="search" autocomplete="off" />
        </div>
      </div>

    </div>
  </div>

</header>


    <div class="page-content">
      <div class="container">
        
  <div class="post">

      <div class="row">
        <div class="col-sm-12">

          <header class="post-header">
            <h1 class="post-title">Apache vs. NGINX: Match of the Millennium</h1>
              
                <h3 class="post-subtitle">Dream match never ends</h3>
              
          </header>

        </div>
      </div>


      <div class="row">
        <div id="post-sidebar" class="col-md-2">

          <aside class="author">
              <div class="author-avatar clearfix">
  
  
      

      <img class="img-circle" src="https://avatars1.githubusercontent.com/u/16487473"
         alt="Claude-Arnaud Perrot's photo">
  
</div>

<div class="aside-meta">Written by</div>
<div class="author-name">
  
    <div class="author-item">
      <div class="author-display-name">Claude-Arnaud Perrot</div>
        
          <div class="author-display-role">Lead Devops</div>
        
    </div>
  
</div>

          </aside>

          <aside class="post-meta-sidebar">
              <div class="aside-meta">Published</div>
<p class="publish-date">
    Jan 20, 2021
</p>

          </aside>

          <aside class="share-buttons">
              <div class="aside-meta">Share this</div>

<a href="https://twitter.com/intent/tweet?text=Apache&#43;vs.&#43;NGINX%3A&#43;Match&#43;of&#43;the&#43;Millennium&amp;url=https%3A%2F%2Fbuild.prestashop-project.org%2Fnews%2Fapache-vs-nginx%2F&amp;via=PrestaShopOrg&amp;related=PrestaShopOrg" rel="nofollow" target="_blank" title="Share on Twitter">
    <i class="icon-twitter-alt"></i>
</a>

<a href="https://facebook.com/sharer.php?u=https%3A%2F%2Fbuild.prestashop-project.org%2Fnews%2Fapache-vs-nginx%2F" rel="nofollow" target="_blank" title="Share on Facebook">
    <i class="icon-facebook-alt"></i>
</a>

          </aside>

        </div>

        <div class="col-md-10">

          <article class="post-content">

              <p>Here is the second article in the <a href="/news/performance-and-prestashop/">performance series we started last year</a>, dealing with the old feud between Apache and NGINX.</p>
<p>As you may have heard of, we will soon publish a <a href="https://content.prestashop.com/hubfs/WhitePaper/PrestaShop_System_Performance.pdf">White Paper about PrestaShop&rsquo;s performances</a>, how to tune your shop, enhance its response time, and so on.</p>
<p>During these benchmarks, we did compare performances between Apache &amp; NGINX, the usual contenders, with identical setups.</p>
<p>Though this article probably won&rsquo;t end the long debate between those two, let&rsquo;s hope it will help you find some clarity on the matter and find out which one is best suited for <em>your</em> configuration. If not both.</p>
<p>Ready to rumble?</p>
<blockquote>
<p>As you&rsquo;ll see, this article will be illustrated by screenshots from the 2D fighting game Garou Mark of the Wolves, belonging to SNK Corporation, as it features a fight between 2 popular webservers.
Of course, there is no real fight there, as hinted by our article&rsquo;s conclusion.
Also, this is an hommage to the fighting games genre, at its height in the 90s, to Garou Mark of the Wolves specifically, one of the best ever released and the work of a company at the height of its savoir-faire.</p>
</blockquote>
<h2 id="player-select">Player Select</h2>
<p class="text-center"><img src="/assets/images/2020/12/MarkoftheWolvesPlayerSelect.jpg" alt="Player Select">
<em>Garou: Mark of the Wolves belongs to SNK Corporation</em></p>
<p>In the left corner, we have the <a href="https://httpd.apache.org/">Apache webserver</a>, developed by the famous Apache Foundation under the Apache License, and coupled with php-fpm.
By default, and design, Apache is fully synchronous, locking a thread (or process, depending on your configuration) for each incoming request.</p>
<p>In the right corner, we have the <a href="https://www.nginx.com/">NGINX webserver</a>, much more recent than Apache, either under a BSD-type license (or a commercial one) and coupled with php-fpm.
By default, and design, NGINX has an asynchronous, non-blocking event-driven architecture, meaning it does not create new threads or processes for each connection.</p>
<p>In order to be fair, we have tested them with the exact same technical stack, the same scenario and the exact same constraints.</p>
<p>Here&rsquo;s a quick reminder of our test parameters:</p>
<ul>
<li>We used PrestaShop version 1.7.6.3 (latest version available at the time) with the same php 7.2 configuration, in a docker environment</li>
<li>Both hosted on a not too shabby <a href="https://console.cloud.google.com">GCP instance</a> with 4vCPU, 15GB RAM and SSD disks</li>
<li>Shops are both configured with 1000 products, 10 suppliers, 2 languages, 5 categories, 1000 orders and a database around 140Mb</li>
<li>We ran the same <a href="https://gatling.io">gatling</a> <a href="https://github.com/PrestaShop/performance-project">crawling scenario</a>, each visitor opening 15 pages per session</li>
<li>The target is to get the most visitors while remaining under 300ms (95th percentile)</li>
</ul>
<p>Hence the following architecture has been used for our tests:</p>
<p class="text-center"><img src="/assets/images/2020/12/TestingArchitecture.png" alt="TestingArchitecture">
<em>The usual suspects</em></p>
<h2 id="fight">FIGHT!</h2>
<p class="text-center"><img src="/assets/images/2020/12/banner-garoumarkofthewolves.jpg" alt="FIGHT">
<em>Garou: Mark of the Wolves belongs to SNK Corporation</em></p>
<p>So, we have launched our scenario on each environment and now the results are coming&hellip; Let&rsquo;s have a look:</p>
<p class="text-center"><img src="/assets/images/2020/12/NginxVSApache2UsersperhourCount.png" alt="VSUsers">
<em>Of course, more users the merrier</em></p>
<p>Are those the results you were expecting?</p>
<h2 id="round-2">Round 2!</h2>
<p>Now, let&rsquo;s see the data we gathered during those tests and check if anything odd appears.</p>
<p>First, the response time and the active users graph built with the Gatling scenario:</p>
<p class="text-center"><img src="/assets/images/2020/12/NGINXRespTime.png" alt="NGINXRespTime">
<em>NGINX active users are just below 100, around 94.</em></p>
<p class="text-center"><img src="/assets/images/2020/12/ApacheRespTime.png" alt="ApacheRespTime">
<em>Apache active users are above 100, around 110.</em></p>
<p>Nothing surprising about the active users, given the result we already had.</p>
<p>Also, looking at the servers metrics, we see that, for both of them, we have plenty of available memory:</p>
<p class="text-center"><img src="/assets/images/2020/12/MemoryUsage.png" alt="MemoryUsage">
<em>Memory usage, not even 10% consumed, we should be fine - excerpt from GCP monitoring</em></p>
<p>Same thing for network and disk IO, far from their limits for both instances:</p>
<p class="text-center"><img src="/assets/images/2020/12/DiskIO.png" alt="DiskIO">
<em>Nothing impressive here, especially for SSD disks - excerpt from GCP monitoring</em></p>
<p class="text-center"><img src="/assets/images/2020/12/NetworkTraffic.png" alt="NetworkTraffic">
<em>Network traffic, nothing specific, excerpt from GCP monitoring</em></p>
<p>More interesting is the CPU, that is almost completely used for both instances:</p>
<p><img src="/assets/images/2020/12/NginxVSApache2CPUUsage.png" alt="CPUUsage"></p>
<p>Some may say that looking at the CPU is not that much intesting, but others, such as us, may disagree.</p>
<p>If you remember our previous talk about performance, you may recall that performance tuning is about finding out the current bottleneck of a system. So, if our CPU <em>is</em> the bottleneck, then it is probably not the memory, the disk or even the network.</p>
<p>Also meaning that the CPU can do its part properly.</p>
<p>In our case, we can conclude there is not much constraint on the system preventing it from serving the application as expected - or at least that the constraints are similar enough.</p>
<p>Also, remember that our task here is to use as much ressources as possible and CPU time means it is not waiting for IOs (disk or network), or managing RAM (neither swapping, as it should be seen on disk), and so on.</p>
<h2 id="ko">K.O.!</h2>
<p>So, now that we&rsquo;ve seen that our system is all up to work at the CPU level, let&rsquo;s try to understand what the Visitors result could mean to all the PrestaShops around the world.</p>
<p>As mentioned earlier, Apache and NGINX designs are very different, Apache using threads/processes for each request and NGINX using an asynchronous system (through an event loop) to manage requests.</p>
<p>Though NGINX&rsquo;s asynchronous design lets it handle enormous charges and loads that Apache cannot, it has a tiny little drawback: latency.
This latency, at least partially, is induced by the events management - it takes time to oversee several events at the &ldquo;same time&rdquo;, to check the different buffers statuses, and so on. Just like any other system, context switching and status management of its different parts does use resources. And more concurrent connections means more latency.</p>
<p>Where apache reduces latency to a minimum with its synchronous design.</p>
<p>It&rsquo;s also worth mentioning that the induced latency is higher for dynamic contents (such as PHP) and very low for static contents (such as JPG, PNG, JS, CSS and so on).</p>
<p>So, even if apache can not handle as much requests as NGINX, it can (not <em>always</em> true, but it does happen) process them faster.</p>
<p>Given all that, we now understand that <em>in our very narrow context</em>, where processing dynamic content, and response time, are critical, NGINX is not the best suited.</p>
<p>Just in case you were wondering, achieving top performance <em>could</em> be done by serving static content through NGINX and dynamic ones through apache.</p>
<h2 id="continue">Continue?</h2>
<p class="text-center"><img src="/assets/images/2020/12/MarkoftheWolvesFinish.png" alt="Continue">
<em>Garou: Mark of the Wolves belongs to SNK Corporation</em></p>
<p>Rest assured we are aware this benchmark is not an exhaustive one and plenty of parameters could have tiped the scale one way or the other.</p>
<p>Still, we do believe this test is relevant and could help understand which configurations are relevant to a given shop.</p>
<p>But don&rsquo;t trust us blindly on this, we have provided you with <a href="https://github.com/PrestaShop/performance-project">the tools</a> to perform your own benchmarks and even the capacity to enhance those tools to reach your own expectactions in different scenarios. Jut have a look and see what you can do with it.</p>
<p>Also worth mentioning is that, using the CPU up to 98% or 99% can be fine for a benchmark but it&rsquo;s something you should never allow on a production server. Any additional load would slow down significantly the server and drastically increase the reponse time to a non acceptable threshold.</p>
<p>It is recommended to <strong>not go up to 40% a server usage</strong> (either cpu usage or load average) in order to deal with peaks and activity surges.</p>
<p>And that should be it for today.</p>
<p>Let us know in the comments if you found anything interesting in this article, if your own test concur with our own or if you have any question regarding this matter!</p>
<p>See you soon for the next article in the series.</p>
<h2 id="about-the-series">About the series</h2>
<p>These are the topics that have currently been covered during this series:</p>
<ol>
<li><a href="/news/performance-and-prestashop/">Performance (&amp; PrestaShop)</a></li>
<li><a href="/news/apache-vs-nginx/">Apache Vs. NGINX : Match Of The Millennium</a></li>
<li><a href="/news/PHP-scalability-and-filesystem/">PHP, scalability &amp; filesystems</a></li>
</ol>


          </article>

            


            

  <div class="post-meta">
    <div class="row">

      <div class="col-md-4">
        <ul class="details">
          <li class="hidden-md hidden-lg">Jan 20, 2021</li>

          
            <li>
              <i class="icon-tag"></i>

              
  <a class="label label-primary" href="/tag/performance/">performance</a>

  <a class="label label-primary" href="/tag/whitepaper/">whitepaper</a>



            </li>
          

        </ul>
      </div>

      
      <div class="col-md-8">
        <div class="author-details">

          <div class="row">
            <div class="col-md-11 col-md-offset-1">

              

                <h5>About the author</h5>

                
    <h4>
      Claude-Arnaud Perrot
      <span>Lead Devops</span>
    </h4>

    
      <a class="btn btn-default btn-sm" href="https://github.com/djodjo3">
        <i class="icon-github-alt"></i> GitHub
      </a>
    
    
    
    
    
  


              

            </div>

          </div>
        </div>
      </div>
      

    </div>
  </div>


        </div>
      </div>

      <div class="row">
  <div class="col-md-12">
    <div id="disqus_thread"></div><div id="disqus_thread"></div>
        <script type="application/javascript">
          window.disqus_config = function () {
              
              
              
          };
          (function() {
            if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
              document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
              return;
            }
            var d = document, s = d.createElement('script'); s.async = true;
            s.src = '//' + "prestashopbuild" + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
</div>

    </div>

      </div>
    </div>

    <footer class="site-footer">
  <div class="container">

    <div class="row">
      <div class="col-sm-12 col-md-8 col-md-offset-2">
        <p>Official blog for PrestaShop development written by
          <a href="/authors">the product and core dev team, and PrestaShop contributors</a>.
        </p>
      </div>
    </div>

    <div class="row">
      <div class="col-sm-12 col-md-8 col-md-offset-2">
        <p>
          <a href="https://www.prestashop.com" target="_self" title="Create your online store with PrestaShop">
            <img id="logo-dotcom" src="/assets/images/theme/logo-prestashop-com.png" alt="Create your online store">
          </a>
        </p>
      </div>
    </div>

    <div class="row">
      <div id="social-icons" class="col-sm-12 col-md-6 col-md-offset-3">

        

        <a href="https://www.youtube.com/@prestashopproject/" title="YouTube channel">
          <i class="icon-youtube-alt"></i>
        </a>

        
        <a href="https://github.com/PrestaShop" title="GitHub repository">
          <i class="icon-github-alt"></i>
        </a>
        

        
        <a href="https://twitter.com/PrestaShopOrg" title="Twitter account">
          <i class="icon-twitter-alt"></i>
        </a>
        

        

        <a href="/feed.xml" title="RSS feed for this blog">
          <i class="icon-rss"></i>
        </a>

      </div>
    </div>

  </div>
</footer>




<script type="text/javascript" src="/js/vendors/jquery-2.1.4.min.js"></script>
<script type="text/javascript" src="/js/vendors/bootstrap.min.js"></script>

<script type="text/javascript" src="/js/vendors/md5.js"></script>

<script type="text/javascript" src="/js/app.js"></script>


  <script src="https://cdn.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script>
  <script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.min.js"></script>
  <script type="text/javascript">

    var client = algoliasearch("17LZR6CZEL", "79e7d4e77871f415092b78b82a66eaf0");
    var index = client.initIndex('jekyll');

    
    autocomplete('#aa-search-input',
      { hint: false, debug: false, autoselect: false, minLength: 4 }, {
        source: autocomplete.sources.hits(index, {hitsPerPage: 6}),
        
        displayKey: 'name',
        
        templates: {
          
          suggestion: function(hit) {
            var str =
              '<a href="' + hit.url + '">' +
              '<span class="hit-title"> ' + hit._highlightResult.title.value + '</span>' +
              '</a>'
            ;

            return str;
          },
          
          empty: function() {
            return '<div class="empty-result">Sorry we couldn\'t find anything.</div>';
          },
          footer: function() {
            return '<p class="algolia-credits">Powered by <img src="/assets/images/theme/algolia.jpg"></p>';
          }
        }
      });
  </script>




  </body>

</html>
